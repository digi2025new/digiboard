{% extends "base.html" %}
{% block content %}
<div class="public-page">
  <h2>{{ department | upper }} Notices - Slideshow</h2>
  <div class="slideshow-container">
    <div class="slideshow">
      {% for notice in notices %}
        <div class="slide">
          {% set file_url = url_for('uploaded_file', filename=notice[0]) %}
          {% if notice[1] in ['png', 'jpg', 'jpeg', 'gif'] %}
            <img src="{{ file_url }}" alt="Notice Image">
          {% elif notice[1] == 'mp4' %}
            <!-- Video element with autoplay attributes -->
            <video src="{{ file_url }}" muted playsinline></video>
          {% elif notice[1] == 'mp3' %}
            <audio src="{{ file_url }}" autoplay controls></audio>
          {% else %}
            <a href="{{ file_url }}" target="_blank" download>View Document</a>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const slides = document.querySelectorAll('.slideshow .slide');
  let currentSlide = 0;
  
  // Hide all slides except the first one
  slides.forEach((slide, index) => {
    if (index !== 0) slide.style.display = 'none';
  });
  
  // Function to handle video slide: reset, load, play and attach ended listener
  function playVideo(slide, callback) {
    const video = slide.querySelector('video');
    if (video) {
      video.pause();
      video.currentTime = 0;
      video.load(); // Reload the video source to reset the video
      video.play().then(() => {
        video.addEventListener('ended', function handler() {
          video.removeEventListener('ended', handler);
          callback();
        });
      }).catch((err) => {
        console.error("Video play error:", err);
        // Fallback: after 5 seconds, go to next slide
        setTimeout(callback, 5000);
      });
    } else {
      callback();
    }
  }
  
  function showNextSlide() {
    const current = slides[currentSlide];
    // If current slide is a video, pause and reset it
    const currentVideo = current.querySelector('video');
    if (currentVideo) {
      currentVideo.pause();
      currentVideo.currentTime = 0;
    }
    current.style.display = 'none';
    
    // Calculate next slide index
    currentSlide = (currentSlide + 1) % slides.length;
    const next = slides[currentSlide];
    next.style.display = 'block';
    
    const nextVideo = next.querySelector('video');
    if (nextVideo) {
      // Use our helper function to reset and auto-play the video
      playVideo(next, showNextSlide);
    } else {
      // For non-video slides, use a fixed display time (e.g., 5 seconds)
      setTimeout(showNextSlide, 5000);
    }
  }
  
  // Start slideshow: check if first slide is a video
  const firstSlide = slides[0];
  const firstVideo = firstSlide.querySelector('video');
  if (firstVideo) {
    playVideo(firstSlide, showNextSlide);
  } else {
    setTimeout(showNextSlide, 5000);
  }
});
</script>
{% endblock %}
